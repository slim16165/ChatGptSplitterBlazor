@page "/"
@using Microsoft.AspNetCore.Components
@inject ChatGptClient ChatGptClient


<PageTitle>ChatGPT Splitter Blazor</PageTitle>

<div class="container my-5" style="padding-bottom: 8rem;">
    <div class="row">
        <div class="col-12">
            <h1><a href="" @onclick="ReloadPage">ChatGPT Splitter</a></h1>

            <p>
                Welcome to <b>ChatGPT Splitter</b>! This tool allows you to...
            </p>
            <hr class="my-3">

            <EditForm Model="formData" OnValidSubmit="HandleValidSubmit">
                @*  <div class="form-group">
                <label for="file">Upload file(s)</label>
                <InputFile id="file" class="form-control-file" @bind-Value="formData.File" multiple />
                </div> *@


                <div class="form-group">
                    <label for="text">Paste your text</label>
                    <InputTextArea id="text" class="form-control my-3" @bind-Value="formData.Text"
                                   rows="8" placeholder="Or paste your text here" />
                </div>

                <div class="row">
                    <div class="col-8">
                        <label for="prompt" class="pr-2">Prompt:</label>
                        <InputTextArea id="prompt" class="form-control" rows="8" placeholder="Enter prompt here" @bind-Value="formData.Prompt" />
                    </div>
                    <div class="col-4 d-flex flex-column justify-content-start">

                        <div class="d-flex justify-content-between align-items-center mt-2">
                            <label>Token Count:</label>
                            <span>@tokenCount</span>
                        </div>

                        <div class="d-flex justify-content-between align-items-center">
                            <label for="chunk_size" class="pr-2">Chunk size:</label>
                            <InputNumber id="chunk_size" class="form-control" @bind-Value="formData.ChunkSize"
                                         style="width: 70%;" />
                        </div>

                        <div class="d-flex justify-content-between align-items-center mt-2">
                            <label>Number of Chunks:</label>
                            <InputNumber class="form-control" @bind-Value="numberOfChunks"
                                 style="width: 70%;" />
                        </div>
                    </div>
                </div>

                <div class="form-group mt-4">
                    <InputCheckbox @bind-Value="formData.UseGpt" /> Use GPT for processing
                </div>




                <div class="form-group mt-3">
                    <button type="submit" class="btn btn-primary">Process</button>
                </div>
            </EditForm>
        </div>
    </div>

    <hr class="my-3">

    @foreach (var chunkIndex in Enumerable.Range(0, chunks.Count))
    {
        var chunk = chunks[chunkIndex];
        <div class="col-12">
            <h2>@(chunkIndex + 1)/@chunks.Count</h2>
            <textarea id="@($"chunk-{chunkIndex}")" class="form-control my-3" rows="10" readonly="">@chunk</textarea>
            <button class="btn btn-success copy-btn" data-clipboard-target="@($"#chunk-{chunkIndex}")">Copy</button>

            <div class="mt-3">
                <strong>Risposta:</strong>
                @if (responses.Count > chunkIndex)
                {
                    <p>@responses[chunkIndex]</p>
                }
                else
                {
                    <p>Response not available.</p>
                }
            </div>
        </div>
    }


</div>

@code {
    private FormData formData;
    List<string> chunks = new();
    // private readonly ChatGptClient chatGptClient = new ChatGptClient();
    readonly List<string> responses = new();
    int tokenCount = 0;

    private int _numberOfChunks;
    public int numberOfChunks
    {
        get => _numberOfChunks;
        set 
        {
            if (_numberOfChunks != value)
            {
                _numberOfChunks = value;
                UpdateChunkSize();
            }
        }
    }


    protected override void OnInitialized()
    {
        formData = new FormData(this);
        numberOfChunks = 1;

    }


    private static void ReloadPage()
    {
        // Ricarica la pagina
        //NavManager.NavigateTo("/splitter", forceLoad: true);
    }

    private void UpdateTextMetrics()
    {
        // Comportamento 1: Ricalcolo in base al cambio di tokenCount
        tokenCount = TextProcessingService.CalculateTokenCount(formData.Text);

        numberOfChunks = TextProcessingService.CalculateNumberOfChunks(tokenCount, formData.ChunkSize);
    }

    private void UpdateChunkSizeMetrics()
    {
        // Comportamento 2: Ricalcolo in base al cambio di chunkSize
        numberOfChunks = TextProcessingService.CalculateNumberOfChunks(tokenCount, formData.ChunkSize);
    }

    private void UpdateChunkSize()
    {
        // Comportamento 3: Ricalcolo in base al cambio di numberOfChunks
        if (numberOfChunks > 0)
        {
            formData.ChunkSize = (int)Math.Ceiling((double)tokenCount / numberOfChunks);
        }
    }

    private async Task HandleValidSubmit()
    {
        var textValue = formData.Text;
        var chunkSizeValue = formData.ChunkSize;

        // 1. Conteggio dei Token
        //https://www.nuget.org/packages/Tiktoken/1.1.1#show-readme-container
        var encoding = Tiktoken.Encoding.ForModel("gpt-4");
        var numberOfTokens = encoding.CountTokens(textValue);

        // 2. Determina il Numero di Chunk
        numberOfChunks = (int)Math.Ceiling((double)numberOfTokens / chunkSizeValue);

        // 3. Trova Punti di Spezzatura Possibili
        List<int> breakPoints = TextProcessingService.FindBreakPoints(textValue);

        // 4. Spezza in Maniera Equilibrata
        chunks = TextProcessingService.SplitTextEqually(textValue, numberOfChunks, breakPoints);

        // 5. Chiamata OpenAPI per ogni chunk
        responses.Clear(); // Azzera le risposte precedenti
        if (formData.UseGpt)
        {
            foreach (var chunk in chunks)
            {
                await CallOpenApiForChunk(chunk);
            }
        }
    }

    private async Task CallOpenApiForChunk(string chunk)
    {
        var response = await ChatGptClient.GenerateTextWithForgeAsync(chunk, formData.Prompt);
        responses.Add(response);
    }

    private class FormData
    {
        private readonly ChatGPTSplitter _parent;

        public FormData(ChatGPTSplitter parent)
        {
            _parent = parent;
            _text = string.Empty;
            _chunkSize = 15000;
        }

        private string _text;
        public string Text
        {
            get => _text;
            set
            {
                if (_text != value)
                {
                    _text = value;
                    _parent.UpdateTextMetrics();
                }
            }
        }

        public string Prompt { get; set; } = "Act like a document/text loader until you load and remember content of the next text/s or document/s.\r\nThere might be multiple files, each file is marked by name in the format ### DOCUMENT NAME.\r\nI will send you them by chunks. Each chunk start will be noted as [START CHUNK x/TOTAL],\r\nand end of this chunk will be noted as [END CHUNK x/TOTAL],\r\nwhere x is number of current chunk and TOTAL is number of all chunks I will send you.\r\nI will send you multiple messages with chunks, for each message just reply OK: [CHUNK x/TOTAL], don't reply anything else, don't explain the text!\r\nLet's begin:\r\n\r\n";

        private int _chunkSize;
        public int ChunkSize 
        {
            get => _chunkSize;
            set 
            {
                if (_chunkSize != value) 
                {
                    _chunkSize = value;
                    _parent.UpdateChunkSizeMetrics();
                }
            }
        }


        public bool UseGpt { get; set; } = false;
    }

}