@page "/"
@using Microsoft.AspNetCore.Components
@inject ChatGptClient ChatGptClient


<PageTitle>ChatGPT Splitter Blazor</PageTitle>

<div class="container my-5" style="padding-bottom: 8rem;">
    <div class="row">
        <div class="col-12">
            <h1><a href="" @onclick="ReloadPage">ChatGPT Splitter</a></h1>

            <p>
                Welcome to <b>ChatGPT Splitter</b>! This tool allows you to...
            </p>
            <hr class="my-3">

            <EditForm Model="formData" OnValidSubmit="HandleValidSubmit">
                @*  <div class="form-group">
                <label for="file">Upload file(s)</label>
                <InputFile id="file" class="form-control-file" @bind-Value="formData.File" multiple />
                </div> *@


                <div class="form-group">
                    <label for="text">Paste your text</label>
                    <InputTextArea id="text" class="form-control my-3" @bind-Value="formData.Text" 
                                   @oninput="UpdateTextMetrics" rows="8" placeholder="Or paste your text here" />
                </div>

                <div class="row">
                    <div class="col-8">
                        <label for="prompt" class="pr-2">Prompt:</label>
                        <InputTextArea id="prompt" class="form-control" rows="8" placeholder="Enter prompt here" @bind-Value="formData.Prompt" />
                    </div>
                    <div class="col-4 d-flex flex-column justify-content-start">
                        
                        <div class="d-flex justify-content-between align-items-center mt-2">
                            <label>Token Count:</label>
                            <span>@tokenCount</span>
                        </div>

                        <div class="d-flex justify-content-between align-items-center">
                            <label for="chunk_size" class="pr-2">Chunk size:</label>
                            <InputNumber id="chunk_size" class="form-control" @bind-Value="formData.ChunkSize" style="width: 70%;"/>
                        </div>

                        <div class="d-flex justify-content-between align-items-center mt-2">
                            <label>Number of Chunks:</label>
                            <InputNumber class="form-control" @bind-Value="numberOfChunks" style="width: 70%;"/>
                        </div>
                    </div>
                </div>

                <div class="form-group mt-4">
                    <InputCheckbox @bind-Value="formData.UseGpt" /> Use GPT for processing
                </div>




                <div class="form-group mt-3">
                    <button type="submit" class="btn btn-primary">Process</button>
                </div>
            </EditForm>
        </div>
    </div>

    <hr class="my-3">

    @foreach (var chunk in chunks)
    {
        <div class="col-12">
            <h2>@(chunks.IndexOf(chunk) + 1)/@chunks.Count</h2>
            <textarea id="@($"chunk-{chunks.IndexOf(chunk)}")" class="form-control my-3" rows="10" readonly="">@chunk</textarea>
            <button class="btn btn-success copy-btn" data-clipboard-target="@($"#chunk-{chunks.IndexOf(chunk)}")">Copy</button>

            <div class="mt-3">
                <strong>Risposta:</strong>
                @if (responses.Count > chunks.IndexOf(chunk))
                {
                    <p>@responses[chunks.IndexOf(chunk)]</p>
                }
                else
                {
                    <p>Response not available.</p>
                }

            </div>
        </div>
    }

</div>

@code {
    private readonly FormData formData = new();
    List<string> chunks = new();
    // private readonly ChatGptClient chatGptClient = new ChatGptClient();
    readonly List<string> responses = new();
    int tokenCount = 0;
    int numberOfChunks = 1;

    private static void ReloadPage()
    {

        // Ricarica la pagina
        //NavManager.NavigateTo("/splitter", forceLoad: true);
    }

    private void UpdateTokenCount()
    {
        if (!string.IsNullOrEmpty(formData.Text))
        {
            var encoding = Tiktoken.Encoding.ForModel("gpt-4");
            tokenCount = encoding.CountTokens(formData.Text);
        }
        else
        {
            tokenCount = 0;
        }
    }

    private void UpdateTextMetrics(ChangeEventArgs e)
    {
        formData.Text = e.Value.ToString();

        UpdateTokenCount();
        CalculateNumberOfChunks();
    }

    private void CalculateNumberOfChunks()
    {
        if (tokenCount == 0)
            numberOfChunks = 1;
        else
            numberOfChunks = (int)Math.Ceiling((double)tokenCount / formData.ChunkSize);
    }

    private async Task HandleValidSubmit()
    {
        var textValue = formData.Text;
        var chunkSizeValue = formData.ChunkSize;

        // 1. Conteggio dei Token
        //https://www.nuget.org/packages/Tiktoken/1.1.1#show-readme-container
        var encoding = Tiktoken.Encoding.ForModel("gpt-4");
        var numberOfTokens = encoding.CountTokens(textValue);

        // 2. Determina il Numero di Chunk
        numberOfChunks = (int)Math.Ceiling((double)numberOfTokens / chunkSizeValue);

        // 3. Trova Punti di Spezzatura Possibili
        List<int> breakPoints = FindBreakPoints(textValue);

        // 4. Spezza in Maniera Equilibrata
        chunks = SplitTextEqually(textValue, numberOfChunks, breakPoints);

        // 5. Chiamata OpenAPI per ogni chunk
        responses.Clear(); // Azzera le risposte precedenti
        if (formData.UseGpt)
        {
            foreach (var chunk in chunks)
            {
                await CallOpenApiForChunk(chunk);
            }
        }
    }

    private static List<int> FindBreakPoints(string text)
    {
        // Aggiungi indice 0 come punto di inizio
        List<int> breakPoints = new List<int> { 0 };

        // Trova tutti i nuovi paragrafi o altri indicatori di spezzatura
        for (int i = 0; i < text.Length; i++)
        {
            // Esempio: Usa il cambio di paragrafo come punto di spezzatura
            if (text[i] == '\n' && i < text.Length - 1 && text[i + 1] == '\n')
            {
                breakPoints.Add(i);
            }
            // Puoi aggiungere altre condizioni per titoli di capitoli, ecc.
        }
        // Aggiungi la fine del testo come ultimo punto di spezzatura
        breakPoints.Add(text.Length);
        return breakPoints;
    }

    private List<string> SplitTextEqually(string text, int numberOfChunks, List<int> breakPoints)
    {
        chunks = new List<string>();
        int approximateChunkSize = text.Length / numberOfChunks;

        int startIndex = 0;
        for (int i = 0; i < numberOfChunks; i++)
        {
            int endIndex = startIndex + approximateChunkSize;

            // Trova il punto di spezzatura più vicino
            while (!breakPoints.Contains(endIndex) && endIndex < text.Length)
            {
                endIndex++;
            }

            endIndex = Math.Min(endIndex, text.Length); // Assicurati che endIndex non superi la lunghezza del testo

            chunks.Add(text.Substring(startIndex, endIndex - startIndex));
            startIndex = endIndex;
        }

        return chunks;
    }
    
    private async Task CallOpenApiForChunk(string chunk)
    {
        var response = await ChatGptClient.GenerateTextWithForgeAsync(chunk, formData.Prompt);
        responses.Add(response);
    }
    
    private class FormData
    {
        public string Text { get; set; }
        // public IBrowserFile File { get; set; }
        public string Prompt { get; set; } = "Act like a document/text loader until you load and remember content of the next text/s or document/s.\r\nThere might be multiple files, each file is marked by name in the format ### DOCUMENT NAME.\r\nI will send you them by chunks. Each chunk start will be noted as [START CHUNK x/TOTAL],\r\nand end of this chunk will be noted as [END CHUNK x/TOTAL],\r\nwhere x is number of current chunk and TOTAL is number of all chunks I will send you.\r\nI will send you multiple messages with chunks, for each message just reply OK: [CHUNK x/TOTAL], don't reply anything else, don't explain the text!\r\nLet's begin:\r\n\r\n";
        public int ChunkSize { get; set; } = 15000;
        public bool UseGpt { get; set; } = false;
    }
}